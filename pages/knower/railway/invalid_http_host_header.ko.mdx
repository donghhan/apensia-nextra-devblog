# Invalid HTTP_HOST header 이슈

## Problem 1

Railway로 Django API 서버를 등록하고자 하는 도중 Invalid HTTP_HOST header 이슈가 생겼다.

## Analysis

배포할 때 [`ALLOWED_HOSTS`](https://docs.djangoproject.com/en/dev/ref/settings/#allowed-hosts)에 Railway API 호스트를 등록하는 것을 깜빡했었다.

## Solution

만일 [`DEBUG`](https://docs.djangoproject.com/en/dev/ref/settings/#std-setting-DEBUG)의 값이 `False`일 때 (즉, 배포용 단계일 때)
환경변수에서 `RAILWAY_HOST_URL`이 존재한다면 `ALLOWED_HOSTS`의 빈 배열에 `RAILWAY_HOST_URL`을 [`append()`](https://docs.python.org/3/library/array.html#array.array.append) 해주었다.

```py settings.py
# ...

if not DEBUG:
    if env("RAILWAY_HOST_URL"):
        ALLOWED_HOSTS.append(env("RAILWAY_HOST_URL"))

# ...
```

---

## Problem 2

배포를 진행하였는데에도 불구하고 Bad Request 400 에러가 계속 떴었다.

## Analysis

[Stack Overflow의 답변](https://stackoverflow.com/a/19875816/13121145)에 의하면 호스트의 header가 `ALLOWED_HOSTS` 배열 중 어느 한 값이라도 일치하지 않아서 생기게 되는
[`SuspiciousOperation`](https://docs.djangoproject.com/en/dev/ref/exceptions/#suspiciousoperation) 에러로 인해 Bad Request 400 에러가 발생하였음을 알게 되었다[^1].

[^1]: [Host header validation](https://docs.djangoproject.com/en/dev/topics/security/#host-headers-virtual-hosting)

## Solution

위의 코드에서 모든 호스트에 대한 허용을 해주기 위해 `*` (와일드카드)를 넣어주었다.

```py settings.py
# ...

ALLOWED_HOSTS = ["*"]

if not DEBUG:
    if env("RAILWAY_HOST_URL"):
        ALLOWED_HOSTS.append(env("RAILWAY_HOST_URL"))

# ...
```

https://www.answeroverflow.com/m/1112141160480243753

```
Indexed
  Compressed [====================] 100%
  Uploaded                                                                                                                                                                                      Build Logs: https://railway.app/project/0d208e17-5353-40a0-9401-dde73151a198/service/bbb5e63d-ce71-4793-a28a-6602cd1ae81a?id=cc4d9fb8-99ed-4915-9ea0-8906b3c881c5&

[Region: us-west1]
==============
Using Nixpacks
==============

context: aaf9e736c10a3fb00e42821ac0752574

╔══════════════════════════════ Nixpacks v1.20.0 ══════════════════════════════╗
║ setup      │ python38, postgresql, gcc                                       ║
║──────────────────────────────────────────────────────────────────────────────║
║ install    │ python -m venv --copies /opt/venv && . /opt/venv/bin/activate   ║
║            │ && pip install -r requirements.txt                              ║
║──────────────────────────────────────────────────────────────────────────────║
║ start      │ python manage.py migrate && gunicorn config.wsgi                ║
╚══════════════════════════════════════════════════════════════════════════════╝


#0 building with "default" instance using docker driver

#1 [internal] load .dockerignore
#1 transferring context: 2B done

#1 DONE 0.0s

#2 [internal] load build definition from Dockerfile
#2 transferring dockerfile: 1.89kB done
#2 DONE 0.0s

#3 [internal] load metadata for ghcr.io/railwayapp/nixpacks:ubuntu-1702339400

#3 DONE 0.2s


#4 [stage-0 1/8] FROM ghcr.io/railwayapp/nixpacks:ubuntu-1702339400@sha256:1a9c1eed040aacf8f898be048210ef2d3366b1228373c4e6818362bb75611b32
#4 DONE 0.0s

#5 [internal] load build context

#5 transferring context: 54.16MB 0.5s done

#5 DONE 0.5s

#6 [stage-0 2/8] WORKDIR /app/
#6 CACHED

#7 [stage-0 3/8] COPY .nixpacks/nixpkgs-5148520bfab61f99fd25fb9ff7bfbb50dad3c9db.nix .nixpacks/nixpkgs-5148520bfab61f99fd25fb9ff7bfbb50dad3c9db.nix
#7 CACHED

#8 [stage-0 4/8] RUN nix-env -if .nixpacks/nixpkgs-5148520bfab61f99fd25fb9ff7bfbb50dad3c9db.nix && nix-collect-garbage -d
#8 CACHED

#9 [stage-0 5/8] COPY . /app/.

#9 DONE 0.3s

#10 [stage-0 6/8] RUN --mount=type=cache,id=s/bbb5e63d-ce71-4793-a28a-6602cd1ae81a-/root/cache/pip,target=/root/.cache/pip python -m venv --copies /opt/venv && . /opt/venv/bin/activate && pip install -r requirements.txt

#10 5.336 Collecting asgiref==3.7.2

#10 5.341   Using cached asgiref-3.7.2-py3-none-any.whl (24 kB)
#10 5.457 Collecting Brotli==1.1.0

#10 5.478   Using cached Brotli-1.1.0-cp38-cp38-manylinux_2_5_x86_64.manylinux1_x86_64.whl (2.8 MB)
#10 5.533 Collecting dj-database-url==2.1.0
#10 5.538   Using cached dj_database_url-2.1.0-py3-none-any.whl (7.7 kB)

#10 5.761 Collecting Django==4.2.7
#10 5.808   Using cached Django-4.2.7-py3-none-any.whl (8.0 MB)

#10 5.949 Collecting django-environ==0.11.2
#10 5.953   Using cached django_environ-0.11.2-py2.py3-none-any.whl (19 kB)
#10 6.047 Collecting djangorestframework==3.14.0

#10 6.057   Using cached djangorestframework-3.14.0-py3-none-any.whl (1.1 MB)
#10 6.127 Collecting djangorestframework-simplejwt==5.3.0
#10 6.131   Using cached djangorestframework_simplejwt-5.3.0-py3-none-any.whl (101 kB)

#10 6.227 Collecting drf-yasg==1.21.7
#10 6.252   Using cached drf_yasg-1.21.7-py3-none-any.whl (4.3 MB)
#10 6.347 Collecting gunicorn==21.2.0

#10 6.352   Using cached gunicorn-21.2.0-py3-none-any.whl (80 kB)
#10 6.392 Collecting inflection==0.5.1
#10 6.396   Using cached inflection-0.5.1-py2.py3-none-any.whl (9.5 kB)
#10 6.464 Collecting packaging==23.2

#10 6.469   Using cached packaging-23.2-py3-none-any.whl (53 kB)

#10 7.120 Collecting Pillow==10.1.0
#10 7.142   Using cached Pillow-10.1.0-cp38-cp38-manylinux_2_28_x86_64.whl (3.6 MB)

#10 7.432 Collecting psycopg2-binary==2.9.9
#10 7.451   Using cached psycopg2_binary-2.9.9-cp38-cp38-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (3.0 MB)

#10 7.528 Collecting PyJWT==2.8.0
#10 7.532   Using cached PyJWT-2.8.0-py3-none-any.whl (22 kB)

#10 7.670 Collecting pytz==2023.3.post1
#10 7.675   Using cached pytz-2023.3.post1-py2.py3-none-any.whl (502 kB)
#10 7.813 Collecting PyYAML==6.0.1

#10 7.818   Using cached PyYAML-6.0.1-cp38-cp38-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (736 kB)
#10 7.868 Collecting sqlparse==0.4.4
#10 7.873   Using cached sqlparse-0.4.4-py3-none-any.whl (41 kB)
#10 7.930 Collecting typing_extensions==4.8.0

#10 7.934   Using cached typing_extensions-4.8.0-py3-none-any.whl (31 kB)
#10 7.972 Collecting uritemplate==4.1.1
#10 7.976   Using cached uritemplate-4.1.1-py2.py3-none-any.whl (10 kB)
#10 8.034 Collecting whitenoise==6.6.0

#10 8.038   Using cached whitenoise-6.6.0-py3-none-any.whl (19 kB)

#10 8.213 Collecting backports.zoneinfo
#10 8.218   Using cached backports.zoneinfo-0.2.1-cp38-cp38-manylinux1_x86_64.whl (74 kB)

#10 8.868 Installing collected packages: pytz, Brotli, whitenoise, uritemplate, typing_extensions, sqlparse, PyYAML, PyJWT, psycopg2-binary, Pillow, packaging, inflection, django-environ, backports.zoneinfo, gunicorn, asgiref, Django, djangorestframework, dj-database-url, drf-yasg, djangorestframework-simplejwt

#10 12.79 Successfully installed Brotli-1.1.0 Django-4.2.7 Pillow-10.1.0 PyJWT-2.8.0 PyYAML-6.0.1 asgiref-3.7.2 backports.zoneinfo-0.2.1 dj-database-url-2.1.0 django-environ-0.11.2 djangorestframework-3.14.0 djangorestframework-simplejwt-5.3.0 drf-yasg-1.21.7 gunicorn-21.2.0 inflection-0.5.1 packaging-23.2 psycopg2-binary-2.9.9 pytz-2023.3.post1 sqlparse-0.4.4 typing_extensions-4.8.0 uritemplate-4.1.1 whitenoise-6.6.0
#10 12.82
#10 12.82 [notice] A new release of pip is available: 23.0.1 -> 23.3.2
#10 12.82 [notice] To update, run: pip install --upgrade pip

#10 DONE 13.0s

#11 [stage-0 7/8] RUN printf '\nPATH=/opt/venv/bin:$PATH' >> /root/.profile

#11 DONE 0.5s


#12 [stage-0 8/8] COPY . /app

#12 DONE 0.3s

#13 exporting to image
#13 exporting layers

#13 exporting layers 1.2s done
#13 writing image sha256:0d18d12639d0bcaf5331fdb848931de4680d73ecf6d475ce146a2d4c8d922948 done

#13 naming to us-west1.registry.rlwy.net/bbb5e63d-ce71-4793-a28a-6602cd1ae81a:cc4d9fb8-99ed-4915-9ea0-8906b3c881c5 0.0s done
#13 DONE 1.2s

=== Successfully Built! ===

Run:
docker run -it us-west1.registry.rlwy.net/bbb5e63d-ce71-4793-a28a-6602cd1ae81a:cc4d9fb8-99ed-4915-9ea0-8906b3c881c5

Build time: 16.96 seconds

================
Publishing Image
================

The push refers to repository [us-west1.registry.rlwy.net/bbb5e63d-ce71-4793-a28a-6602cd1ae81a]
Preparing  763e67ae6dc4
Preparing  5dfde5ec59d9
Preparing  0d562fcb7f39
Preparing  2644eaf556c5
Preparing  b8f3bb8923b1
Preparing  a7fd9c7aead9
Preparing  708cd238adb1
Preparing  b7d9d5786e3c
Preparing  64e592e3d51e
Waiting  2644eaf556c5
Waiting  b8f3bb8923b1
Preparing  8ceb9643fb36
Waiting  a7fd9c7aead9
Waiting  64e592e3d51e
Waiting  8ceb9643fb36
Waiting  708cd238adb1
Waiting  b7d9d5786e3c
Pushing [==================================================>]     512B 5dfde5ec59d9
Pushing [==================================================>]   2.56kB 5dfde5ec59d9
Pushing [>                                                  ]    535kB/93.59MB 0d562fcb7f39
Pushing [>                                                  ]  524.8kB/54.05MB 763e67ae6dc4
Pushing [=>                                                 ]  2.668MB/93.59MB 0d562fcb7f39
Pushing [==>                                                ]  2.663MB/54.05MB 763e67ae6dc4
Pushing [==>                                                ]  4.834MB/93.59MB 0d562fcb7f39
Pushing [====>                                              ]  4.819MB/54.05MB 763e67ae6dc4
Pushing [===>                                               ]  6.487MB/93.59MB 0d562fcb7f39
Pushing [======>                                            ]  7.001MB/54.05MB 763e67ae6dc4
Pushing [====>                                              ]  9.254MB/93.59MB 0d562fcb7f39
Pushing [========>                                          ]  9.211MB/54.05MB 763e67ae6dc4
Pushing [======>                                            ]  11.43MB/93.59MB 0d562fcb7f39
Pushing [==========>                                        ]  11.44MB/54.05MB 763e67ae6dc4
Pushing [=======>                                           ]   13.6MB/93.59MB 0d562fcb7f39
Pushed  5dfde5ec59d9
Pushing [============>                                      ]  13.64MB/54.05MB 763e67ae6dc4
Pushing [========>                                          ]  15.83MB/93.59MB 0d562fcb7f39
Layer already exists  b8f3bb8923b1
Pushing [>                                                  ]  524.8kB/54.05MB 2644eaf556c5
Pushing [=========>                                         ]   17.5MB/93.59MB 0d562fcb7f39
Pushing [==============>                                    ]  15.31MB/54.05MB 763e67ae6dc4
Pushing [==>                                                ]  2.666MB/54.05MB 2644eaf556c5
Layer already exists  a7fd9c7aead9
Pushing [==========>                                        ]  20.26MB/93.59MB 0d562fcb7f39
Pushing [================>                                  ]  17.54MB/54.05MB 763e67ae6dc4
Pushing [====>                                              ]  4.823MB/54.05MB 2644eaf556c5
Pushing [===========>                                       ]   22.4MB/93.59MB 0d562fcb7f39
Pushing [==================>                                ]  20.28MB/54.05MB 763e67ae6dc4
Layer already exists  708cd238adb1
Pushing [======>                                            ]  7.004MB/54.05MB 2644eaf556c5
Pushing [=============>                                     ]  24.53MB/93.59MB 0d562fcb7f39
Pushing [=====================>                             ]  22.97MB/54.05MB 763e67ae6dc4
Pushing [========>                                          ]  9.214MB/54.05MB 2644eaf556c5
Layer already exists  b7d9d5786e3c
Pushing [==============>                                    ]  26.66MB/93.59MB 0d562fcb7f39
Pushing [=======================>                           ]  25.18MB/54.05MB 763e67ae6dc4
Pushing [==========>                                        ]  10.89MB/54.05MB 2644eaf556c5
Pushing [===============>                                   ]  28.79MB/93.59MB 0d562fcb7f39
Layer already exists  64e592e3d51e
Pushing [========================>                          ]  26.83MB/54.05MB 763e67ae6dc4
Pushing [============>                                      ]  13.08MB/54.05MB 2644eaf556c5
Pushing [================>                                  ]  30.91MB/93.59MB 0d562fcb7f39
Layer already exists  8ceb9643fb36
Pushing [==========================>                        ]  28.99MB/54.05MB 763e67ae6dc4
Pushing [=============>                                     ]  14.75MB/54.05MB 2644eaf556c5
Pushing [=================>                                 ]  33.04MB/93.59MB 0d562fcb7f39
Pushing [===========================>                       ]   30.1MB/54.05MB 763e67ae6dc4
Pushing [===============>                                   ]  16.42MB/54.05MB 2644eaf556c5
Pushing [===================>                               ]  35.68MB/93.59MB 0d562fcb7f39
Pushing [=============================>                     ]  32.23MB/54.05MB 763e67ae6dc4
Pushing [=================>                                 ]  18.62MB/54.05MB 2644eaf556c5
Pushing [====================>                              ]  37.79MB/93.59MB 0d562fcb7f39
Pushing [===================>                               ]  20.82MB/54.05MB 2644eaf556c5
Pushing [===============================>                   ]  34.41MB/54.05MB 763e67ae6dc4
Pushing [=====================>                             ]  39.36MB/93.59MB 0d562fcb7f39
Pushing [=====================>                             ]  22.98MB/54.05MB 2644eaf556c5
Pushing [======================>                            ]  41.47MB/93.59MB 0d562fcb7f39
Pushing [=================================>                 ]   36.6MB/54.05MB 763e67ae6dc4
Pushing [=======================>                           ]  25.18MB/54.05MB 2644eaf556c5
Pushing [======================>                            ]  43.05MB/93.59MB 0d562fcb7f39
Pushing [===================================>               ]   38.8MB/54.05MB 763e67ae6dc4
Pushing [=======================>                           ]  44.63MB/93.59MB 0d562fcb7f39
Pushing [====================================>              ]   39.9MB/54.05MB 763e67ae6dc4
Pushing [========================>                          ]  26.83MB/54.05MB 2644eaf556c5
Pushing [========================>                          ]  46.23MB/93.59MB 0d562fcb7f39
Pushing [======================================>            ]  41.53MB/54.05MB 763e67ae6dc4
Pushing [==========================>                        ]  28.99MB/54.05MB 2644eaf556c5
Pushing [=======================================>           ]  42.64MB/54.05MB 763e67ae6dc4
Pushing [=========================>                         ]  48.37MB/93.59MB 0d562fcb7f39
Pushing [===========================>                       ]   30.1MB/54.05MB 2644eaf556c5
Pushing [========================================>          ]   44.3MB/54.05MB 763e67ae6dc4
Pushing [==========================>                        ]  49.98MB/93.59MB 0d562fcb7f39
Pushing [=============================>                     ]  32.24MB/54.05MB 2644eaf556c5
Pushing [==========================================>        ]  45.93MB/54.05MB 763e67ae6dc4
Pushing [===========================>                       ]   52.1MB/93.59MB 0d562fcb7f39
Pushing [===============================>                   ]  34.42MB/54.05MB 2644eaf556c5
Pushing [============================================>      ]  48.07MB/54.05MB 763e67ae6dc4
Pushing [============================>                      ]  53.77MB/93.59MB 0d562fcb7f39
Pushing [=================================>                 ]  36.61MB/54.05MB 2644eaf556c5
Pushing [==============================================>    ]  50.24MB/54.05MB 763e67ae6dc4
Pushing [=============================>                     ]  55.44MB/93.59MB 0d562fcb7f39
Pushing [===================================>               ]  38.81MB/54.05MB 2644eaf556c5
Pushing [================================================>  ]  52.94MB/54.05MB 763e67ae6dc4
Pushing [==============================>                    ]  57.66MB/93.59MB 0d562fcb7f39
Pushing [=====================================>             ]  40.46MB/54.05MB 2644eaf556c5
Pushing [===============================>                   ]  59.86MB/93.59MB 0d562fcb7f39
Pushing [==================================================>]  54.93MB 763e67ae6dc4
Pushing [=======================================>           ]  42.64MB/54.05MB 2644eaf556c5
Pushing [================================>                  ]  61.51MB/93.59MB 0d562fcb7f39
Pushing [========================================>          ]   44.3MB/54.05MB 2644eaf556c5
Pushing [==================================>                ]  63.71MB/93.59MB 0d562fcb7f39
Pushing [==========================================>        ]  46.46MB/54.05MB 2644eaf556c5
Pushing [==================================>                ]  65.38MB/93.59MB 0d562fcb7f39
Pushing [============================================>      ]  48.61MB/54.05MB 2644eaf556c5
Pushing [===================================>               ]  66.96MB/93.59MB 0d562fcb7f39
Pushing [===============================================>   ]  51.31MB/54.05MB 2644eaf556c5
Pushing [====================================>              ]   69.1MB/93.59MB 0d562fcb7f39
Pushing [=================================================> ]  53.48MB/54.05MB 2644eaf556c5
Pushing [==================================================>]  54.94MB 2644eaf556c5
Pushing [======================================>            ]  71.24MB/93.59MB 0d562fcb7f39
Pushed  763e67ae6dc4
Pushing [=======================================>           ]  73.94MB/93.59MB 0d562fcb7f39
Pushing [========================================>          ]  76.06MB/93.59MB 0d562fcb7f39
Pushing [=========================================>         ]  78.22MB/93.59MB 0d562fcb7f39
Pushing [==========================================>        ]  80.36MB/93.59MB 0d562fcb7f39
Pushing [============================================>      ]  82.58MB/93.59MB 0d562fcb7f39
Pushing [=============================================>     ]  84.78MB/93.59MB 0d562fcb7f39
Pushed  2644eaf556c5
Pushing [==============================================>    ]  86.94MB/93.59MB 0d562fcb7f39
Pushing [===============================================>   ]  89.05MB/93.59MB 0d562fcb7f39
Pushing [================================================>  ]  91.16MB/93.59MB 0d562fcb7f39
Pushing [=================================================> ]  93.32MB/93.59MB 0d562fcb7f39
Pushing [==================================================>]  95.42MB 0d562fcb7f39
Pushing [==================================================>]  97.58MB 0d562fcb7f39
Pushing [==================================================>]  99.79MB 0d562fcb7f39
Pushing [==================================================>]    101MB 0d562fcb7f39
Pushed  0d562fcb7f39
cc4d9fb8-99ed-4915-9ea0-8906b3c881c5: digest: sha256:4dbb64d1a86797e7d465fce5579570446665d57365cb2896ed17a7bfb2a62803 size: 2424

Publish time: 8.47 seconds
Operations to perform:
Apply all migrations: admin, auth, contenttypes, lookbooks, products, sessions, token_blacklist, users
Running migrations:
No migrations to apply.
[2024-01-30 10:58:12 +0000] [7] [INFO] Starting gunicorn 21.2.0
[2024-01-30 10:58:12 +0000] [7] [INFO] Listening at: http://0.0.0.0:6378 (7)
[2024-01-30 10:58:12 +0000] [7] [INFO] Using worker: sync
[2024-01-30 10:58:12 +0000] [13] [INFO] Booting worker with pid: 13
```
